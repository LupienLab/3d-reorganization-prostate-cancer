# ==============================================================================
# Meta Rules
# ==============================================================================
rule all:
    input:
        "gencode.v33.genes.sorted.bed",
        "gencode.v33.tss.sorted.bed",
        "gencode.v33.all-genes.bed"

# ==============================================================================
# Rules
# ==============================================================================
rule download_annotation:
    output:
        temp("gencode.v33.annotation.gtf.gz")
    shell:
        "curl -O ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_33/gencode.v33.annotation.gtf.gz"

rule all_genes:
    input:
        "gencode.v33.annotation.gtf"
    output:
        "gencode.v33.all-genes.bed"
    shell:
        # use either tab or "; " as field separators
        # only keep genes
        "awk '{{FS=\"(\\t|; )\"; OFS=\"\\t\"}}{{if (NR > 5 && $3 == \"gene\"){{gsub(/gene_id \"/, \"\", $9); gsub(/\"/, \"\", $9); gsub(/gene_name \"/, \"\", $11); gsub(/\"/, \"\", $11); print $1, $4, $5, $7, $9, $11}} }}' {input} > {output}"

rule filter:
    input:
        script = "filter-gencode.R",
        data = "gencode.v33.annotation.gtf"
    output:
        "gencode.v33.genes.bed",
        "gencode.v33.tss.bed",
    shell:
        "Rscript {input.script}"

rule sort:
    input:
        "{file}.bed"
    output:
        "{file}.sorted.bed"
    shell:
        "sort -k 1,1 -V -k2,2n {input} > {output}"
