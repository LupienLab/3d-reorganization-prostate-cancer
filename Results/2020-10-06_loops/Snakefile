# ==============================================================================
# Configuration
# ==============================================================================
import pandas as pd
import os.path as path

CONFIG = pd.read_csv("config.tsv", index_col=False, sep="\t")
CONFIG = CONFIG.loc[CONFIG.Include == "Yes", :]

SAMPLES = CONFIG["SampleID"].tolist()

LOOP_DIR = path.join("..", "..", "Data", "Processed", "2019-06-18_PCa-LowC-sequencing", "Loops")
PROC_DIR = "Loops"
TRACK_DIR = "Tracks"
PLOT_DIR = "Plots"

# ==============================================================================
# Meta Rules
# ==============================================================================
rule all:
	input:
		path.join(PROC_DIR, "merged-loops.tsv"),
		path.join(PROC_DIR, "merged-loops.sample-counts.tsv"),
		path.join(PROC_DIR, "shared-loops.tsv"),
		path.join(PROC_DIR, "benign-specific-loops.tsv"),
		path.join(PROC_DIR, "tumour-specific-loops.tsv"),
		path.join(PLOT_DIR, "loop-calls.by-sample.pdf"),
		path.join(PLOT_DIR, "loop-calls.by-sample.png"),
		path.join(PLOT_DIR, "loop-calls.by-type.pdf"),
		path.join(PLOT_DIR, "loop-calls.by-type.png"),
		expand(
			path.join(PROC_DIR, "by-sample", "{sample}.flat-loops.bed"),
			sample=SAMPLES,
		),
		path.join(TRACK_DIR, "merged-loops.sample-counts.bed2ddb"),
		path.join(PROC_DIR, "loop-saturation.model-estimates.tsv"),
		path.join(PROC_DIR, "loop-saturation.saturation-estimates.tsv"),
		path.join(PROC_DIR, "loop-saturation.bootstraps.tsv"),
		path.join(PROC_DIR, "loop-saturation.bootstrap-summary.tsv"),
		path.join(PLOT_DIR, "loop-saturation.All.png"),
		# path.join(PROC_DIR, "stack.obj"),


# ==============================================================================
# Rules
# ==============================================================================
rule anchors:
	input:
		script = "get-anchors.R",
		data = expand(
			path.join(LOOP_DIR, "{sample}.res_10000bp.loops.tsv"),
			sample=SAMPLES,
		),
	output:
		path.join(PROC_DIR, "merged-loops.tsv"),
		path.join(PROC_DIR, "merged-loops.sample-counts.tsv"),
		path.join(PROC_DIR, "shared-loops.tsv"),
		path.join(PROC_DIR, "benign-specific-loops.tsv"),
		path.join(PROC_DIR, "tumour-specific-loops.tsv"),
		path.join(PLOT_DIR, "loop-calls.by-sample.pdf"),
		path.join(PLOT_DIR, "loop-calls.by-sample.png"),
		path.join(PLOT_DIR, "loop-calls.by-type.pdf"),
		path.join(PLOT_DIR, "loop-calls.by-type.png"),
	shell:
		"Rscript {input.script}"

rule split_loops_by_sample:
	input:
		script = "split-loops.awk",
		data = path.join(PROC_DIR, "merged-loops.tsv"),
	output:
		expand(
			path.join(PROC_DIR, "by-sample", "{sample}.loops.bedpe"),
			sample=SAMPLES,
		),
	shell:
		"awk -f {input.script} {input.data}"

rule flatten_split_loops:
	input:
		path.join(PROC_DIR, "by-sample", "{sample}.loops.bedpe"),
	output:
		path.join(PROC_DIR, "by-sample", "{sample}.flat-loops.bed"),
	shell:
		"awk '{{FS=OFS=\"\t\"}}{{ print $1, $2, $3, $7, $8, $10, $11; print $4, $5, $6, $7, $9, $10, $11; }}' {input} > {output}"

rule loop_saturation:
	input:
		script = "loop-saturation.R",
		loops = path.join(PROC_DIR, "merged-loops.tsv"),
	output:
		path.join(PROC_DIR, "loop-saturation.model-estimates.tsv"),
		path.join(PROC_DIR, "loop-saturation.saturation-estimates.tsv"),
		path.join(PROC_DIR, "loop-saturation.bootstraps.tsv"),
		path.join(PROC_DIR, "loop-saturation.bootstrap-summary.tsv"),
		path.join(PLOT_DIR, "loop-saturation.All.png"),
	shell:
		"Rscript {input.script}"

rule clodius_2d:
	input:
		path.join(PROC_DIR, "{file}.tsv"),
	output:
		path.join(TRACK_DIR, "{file}.bed2ddb"),
	params:
		"--assembly hg38 --has-header --chr1-col 1 --from1-col 2 --to1-col 3 --chr2-col 4 --from2-col 5 --to2-col 6"
	shell:
		"clodius aggregate bedpe {params} -o {output} {input}"

rule apa:
	input:
		script = "apa.py",
		shared = path.join(PROC_DIR, "merged-loops.sample-counts.tsv"),
	output:
		path.join(PROC_DIR, "stack.obj"),
	shell:
		"python {input.script}"

rule plot_apa:
	input:
		script = "plot-apa.py",
		data = expand(
			path.join(PROC_DIR, "condition_pile.{loop_type}.obj"),
			loop_type=["shared", "benign", "tumour"],
		),
	output:
		path.join(PLOT_DIR, "apa.png"),
	shell:
		"python {input.script}"

rule plot_apa_by_sample:
	input:
		script = "plot-sample-apa.py",
		data = expand(
			path.join(PROC_DIR, "pile.{loop_type}.obj"),
			loop_type=["shared", "benign", "tumour"],
		),
	output:
		path.join(PLOT_DIR, "apa.by-sample.png"),
	shell:
		"python {input.script}"
