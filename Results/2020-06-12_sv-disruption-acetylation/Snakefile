# ==============================================================================
# Environment
# ==============================================================================
import os.path as path
import pandas as pd

CONFIG = pd.read_csv(
    path.join("..", "..", "Data", "External", "LowC_Samples_Data_Available.tsv"),
    sep="\t",
    header=0
)
SAMPLES = ["PCa" + str(i) for i in CONFIG.loc[CONFIG.Include == "Yes", "Sample ID"]]

ACETYL_DIR = "Acetylation"
TRACK_DIR = "Tracks"
PLOT_DIR = "Plots"
GRAPH_DIR = path.join("..", "2020-02-19_chromoplexy", "Graphs")
TAD_DIR = path.join("..", "2020-01-15_TAD-aggregation", "resolved-TADs")
CHIP_DIR = path.join("..", "..", "Data", "Processed", "2019-05-03_PCa-H3K27ac-peaks", "BAMs")

PLOT_EXTS = ["png", "pdf"]
TESTS = pd.read_csv(
    path.join(GRAPH_DIR, "sv-disruption-tests.tsv"),
    sep="\t",
    header=0
)
TEST_IDS = sorted(TESTS.test_ID.tolist())


# ==============================================================================
# Meta Rules
# ==============================================================================
rule all:
    input:
        "dba_all.rds",
        path.join(PLOT_DIR, "T2E", "position.png"),
        path.join(PLOT_DIR, "T2E", "position.ERG.png"),
        path.join(PLOT_DIR, "T2E", "position.TMPRSS2.png"),
        path.join(ACETYL_DIR, "Tests", "test_6.local.tsv"),
        expand(
            path.join(PLOT_DIR, "Distribution", "acetylation.{plot}.{ext}"),
            plot=["p-values", "p-values.all-tests", "qq-plot", "volcano"],
            ext=PLOT_EXTS,
        ),
        path.join(TRACK_DIR, "peaks-catalogue.beddb"),

# ==============================================================================
# Rules
# ==============================================================================
rule t2e_diffbind:
    input:
        script = "t2e-diffbind.R",
        data = "config.tsv"
    output:
        "dba_all.rds",
        path.join(ACETYL_DIR, "T2E", "dba_comp.rds"),
        path.join(ACETYL_DIR, "T2E", "t2e.all.tsv"),
        path.join(ACETYL_DIR, "T2E", "t2e.local.tsv"),
    shell:
        "Rscript {input.script}"

rule plot_t2e_diffbind:
    input:
        script = "plot-t2e-diffbind.R",
        rds = path.join(ACETYL_DIR, "T2E", "dba_comp.rds"),
        all_data = path.join(ACETYL_DIR, "T2E", "t2e.all.tsv"),
        local_data = path.join(ACETYL_DIR, "T2E", "t2e.local.tsv"),
    output:
        path.join(PLOT_DIR, "T2E", "position.png"),
        path.join(PLOT_DIR, "T2E", "position.ERG.png"),
        path.join(PLOT_DIR, "T2E", "position.TMPRSS2.png"),
    shell:
        "Rscript {input.script}"

rule diffbind:
    input:
        script = "diffbind.R",
        tests = path.join(GRAPH_DIR, "sv-disruption-tests.tsv"),
        tads = path.join("..", "2020-02-19_sv-disruption-TADs", "sv-disruption-tests.TADs.tsv"),
        path.join(ACETYL_DIR, "Tests", "test_6.local.tsv"),
    output:
    shell:
        "Rscript {input.script}"

rule plot_diffbind:
    input:
        script = "plot-acetylation.R",
        data = path.join("Acetylation", "Tests", "test_6.local.tsv"),
    output:
        expand(
            path.join(PLOT_DIR, "Distribution", "acetylation.{plot}.{ext}"),
            plot=["p-values", "p-values.all-tests", "qq-plot", "volcano"],
            ext=PLOT_EXTS,
        )
    shell:
        "Rscript {input.script}"

rule clodius_peak_catalogue:
    input:
        path.join(ACETYL_DIR, "T2E", "t2e.all.tsv"),
    output:
        path.join(TRACK_DIR, "peaks-catalogue.beddb"),
    params:
        "-a hg38 --has-header"
    shell:
        "clodius aggregate bedfile {params} -o {output} {input}"
